/*! WKeditor - v1.0 - 2013-09-23 5:56:06 PM
* Copyright (c) 2013 changyuan.lcy; Licensed  */
KISSY.add("gallery/WKeditor/1.0/index",function(S,Node,Base,XTemplate){function WKeditor(a){var b=this;WKeditor.superclass.constructor.call(b,a),this.ele=this.get("ele"),this.init()}var EMPTY="",$=Node.all;return WKeditor.prototype.init=function(){this.view(),this.event(),this.get("plugin")&&this.plugin(this.get("plugin")),this.get("font")&&this.font(this.get("font"))},WKeditor.prototype.tpl={wrap:$("<div class='WKeditor_wrap'></div>"),plugin:[{name:"product",label:"\u63d2\u5165\u4ea7\u54c1"},{name:"video",label:"\u63d2\u5165\u89c6\u9891"},{name:"image",label:"\u63d2\u5165\u56fe\u7247"}]},WKeditor.prototype.view=function(){var a=this;this.view.init=function(){a.$wrap=$(a.tpl.wrap),a.$wrap.attr("contenteditable",!0),a.$wrap.html(a.get("message")),a.plugin(),a.ele.append(a.$wrap)},this.view.init()},WKeditor.prototype.plugin=function(a){var b=this;this.plugin.tpl={plugin:{product:"\u63d2\u5165\u4ea7\u54c1",video:"\u63d2\u5165\u89c6\u9891",image:"\u63d2\u5165\u56fe\u7247"},wrap:"<div class='WKeditor_plugin'></div>",btn:"<div class='box'>[data]<button class='{name}' title='{text}'></button>[/data]</div>"},this.plugin.init=function(){b.plugin.view(),b.plugin.event()},this.plugin.view=function(){b.$plugin=$(b.plugin.tpl.wrap),arr=[],temp="",i=0;for(var c in a)arr[i]={name:c,text:b.plugin.tpl.plugin[c]},i++;temp=b.tool.template(b.plugin.tpl.btn,{data:arr}),b.$plugin.append(temp),b.ele.append(b.$plugin),b.$plugin.height(37*b.$plugin.all("button").length)},this.plugin.event=function(){b.$plugin.delegate("button","click",function(){var a=$(this).attr("class");return b[a](),!1})},this.plugin.init()},WKeditor.prototype.event=function(){var a=this;a.$wrap.on("click",function(){a.tool.removeHTML(a.$wrap.html())==a.tool.removeHTML(a.get("message"))&&$(this).html(""),$(this).fire("focus")}).on("blur",function(){""==$(this).html().replace("<span></span>","").replace("<br>","")&&$(this).html(a.get("message"))}).on("mousedown",function(b){a.set("mousedown",!0),a.set("mouseOD",{left:b.clientX,top:b.clientY+$(window).scrollTop()}),a.$font.hide(),a.get("range")&&a.tool.setCart(a.$wrap[0],a.get("range"))}).on("mouseup",function(b){a.set("mouseOU",{left:b.clientX,top:b.clientY+$(window).scrollTop()}),a.set("mousedown",!1);var c=a.tool.getRange(),d=a.get("mouseOD").left-(a.get("mouseOD").left-a.get("mouseOU").left)/2-a.$font.width()/2,e=a.get("mouseOD").top-(a.get("mouseOD").top-a.get("mouseOU").top)/2-a.$font.height()-20;d+a.$font.width()/2<a.ele.offset().left&&(d=a.ele.offset().left-a.$font.width()/2),d+a.$font.width()/2>a.ele.offset().left+a.ele.width()&&(d=a.ele.offset().left+a.ele.width()-a.$font.width()/2),e<a.ele.offset().top&&(e=a.ele.offset().top-a.$font.height()-10),e>a.ele.offset().top+a.ele.height()&&(e=a.ele.offset().top+a.ele.height()-a.$font.height()-10),setTimeout(function(){try{c.selectText&&(a.set("range",c),a.$font.show(),a.$font.css({left:d,top:e}))}catch(b){}},1)}).on("mousemove",function(b){var c=b.target;switch(c.tagName.toLowerCase()){case"img":a.event.showImgOp(c);break;default:a.event.hideImgOp()}}).on("keydown",function(b){13==b.keyCode&&setTimeout(function(){S.each(a.$wrap.all("p"),function(a){0==$(a).all("img").length&&0==$(a).all("embed").length&&0==$(a).all("video").length&&$(a).removeAttr("class").removeAttr("style")}),a.tool.formatBlock(a)},10)})[0].onpaste=function(b){a.event.shotImg(b)},$(document).on("mouseup",function(b){return a.get("mousedown")?(a.$wrap.fire("mouseup",b),a.set("mouseOU",{left:b.clientX,top:b.clientY+$(window).scrollTop()})):S.inArray(b.target,a.$font.all("button"))||a.$font.hide(),!1}),a.event.shotImg=function(b){var c=b.clipboardData;if(c&&c.items){items=c.items;var d=items[0];if("file"==d.kind&&"image/png"==d.type){var e=new FileReader;e.onloadend=function(b){var b=this.result.substr(this.result.indexOf(",")+1),c=document.createElement("img");c.src="data:image/jpeg;base64,"+b,a.tool.insert(c,a.tool.getRange())},e.readAsDataURL(d.getAsFile())}}},a.event.showImgOp=function(b){function c(){var b=d.all(".centerImage");0==d.all(".centerImage").length&&(b=$("<button class='centerImage'>\u5c45\u4e2d</button>"),d.append(b)),b.css({left:e.offset().left+e.width()-33-46,top:e.offset().top,position:"absolute",display:"block"}),b.detach("click").on("click",function(){var b=$("<p style='text-align:center'></p>");return e.before(b),b.append(e),a.event.hideImgOp(),!1})}var d=a.ele,e=$(b);void function(){var a=d.all(".removeImage");0==d.all(".removeImage").length&&(a=$("<button class='removeImage'></button>"),d.append(a)),a.css({left:e.offset().left+e.width()-33,top:e.offset().top,position:"absolute",display:"block"}),a.on("click",function(){if(e.attr("loadingid")){var b=$("#editorMain").all("img[loadingid="+e.attr("loadingid")+"]");b.length>0&&b.remove()}return e.remove(),a.hide(),!1})}(),"center"!=e.parent().css("text-align")&&c()},a.event.hideImgOp=function(){var b=a.ele;void function(){var a=b.all(".removeImage");a&&a.hide()}(),void function(){var a=b.all(".centerImage");a&&a.hide()}()}},WKeditor.prototype.reg={hrefReg:/http:\/\/[a-zA-Z\d.]*wanke.etao.com[\/a-zA-Z\d?=.&+%]*/g,cdnReg:/taobaocdn[.a-z]*\/tfscom/,fliterReg:"IMG|P|SPAN|FONT|A|UL|LI|DIV|H1|H2|H3|H4|H5|H6|BR|EMBED|EM|VIDEO|B|STRONG|U|LABEL|BIG|S|I|OL|DL|DD|DT|SUB|SUP"},WKeditor.prototype.language={video:"\u8bf7\u7c98\u8d34\u89c6\u9891\u5730\u5740",video2:"\u652f\u6301\u6dd8\u5b9d\u3001\u4f18\u9177\u3001\u571f\u8c46\u3001\u91776\u3001\u641c\u72d0\u7f51\u7ad9\u89c6\u9891\u94fe\u63a5",product:"\u8bf7\u8f93\u5165\u4f60\u60f3\u5206\u4eab\u7684\u4e1c\u897f\u540d\u79f0",save:"\u6b63\u5728\u4fdd\u5b58...",saveSuc:"\u4fdd\u5b58\u6210\u529f"},WKeditor.prototype.command={setFontBold:function(){document.execCommand("Bold",!1,!0)},setContentItalic:function(){document.execCommand("Italic",!1,!0)},setContentUnderline:function(){document.execCommand("Underline",!1,!0)},setFontSize:function(a){document.execCommand("FontSize",!1,a),"2"==a&&document.execCommand("RemoveFormat")},insertUnorderedList:function(){document.execCommand("InsertUnorderedList",!1,null)}},WKeditor.prototype.image=function(){var a=this;this.image.init=function(){a.image.view(),a.image.event()},this.image.tpl={wrap:'<div class="WKeditor_image_plate" id="WKeditor_image_plate">                <div class="uploadBox">                    <p class="canDragMsg">\uff08\u62d6\u62fd\u56fe\u7247\u53ef\u4fee\u6539\u987a\u5e8f\uff09</p>                    <ul id="J_UploaderQueue" class="grid"></ul>                    <div class="box">                        <p class="top">\u53ef\u62d6\u52a8\u591a\u5f20\u672c\u5730\u56fe\u7247\u5230\u8fd9\u91cc\u4e0a\u4f20<br/>\u6216</p>                        <div class="up_btn"><a href="javascript:void(0)" class="btn-uploader wk-btn btn-bg-blue btn-large"><span class="btn-text">\u9009\u62e9\u6587\u4ef6</span><div class="file-input-wrapper" style="overflow: hidden;"><input type="file" name="Filedata" hidefocus="true" class="file-input" style="" multiple="multiple"></div></a>                        <a class="btn-confirm wk-btn btn-bg-blue btn-large">\u786e\u8ba4\u63d2\u5165</a></div>                        <p class="text">Jpg\uff0cGif\uff0cPNG,\u5355\u5f20\u6700\u59276M</br>\u56fe\u7247\u5c3a\u5bf8\u8d85\u8fc7480*270\u50cf\u7d20\u53ef\u4ee5\u5728\u9996\u9875\u5c55\u793a\u7f29\u7565\u56fe</p>                    </div>                </div><div class="close">\xd7</div>            </div>'},this.image.view=function(){a.$image=$(a.image.tpl.wrap),a.ele.append(a.$image),a.$image.width(a.ele.width()).show(),a.$image.css({zIndex:100,left:($(window).width()-a.$image.width())/2,top:($(window).height()-a.$image.height())/2}),$.plugin("Dmimi.overlay",{ele:a.$image},function(b){a.$overlay=b.$overlay}),a.image.view.preview=function(a){var b=$('<li class="queue-file"><div class="imageBox"><div class="pic"><img loadid="'+a+'"/></div>'+'<div class="operate"><span title="\u5de6\u65cb" class="rotatel"></span>'+'<span title="\u53f3\u65cb" class="rotate"></span>'+'<span title="\u5220\u9664" class="del-pic"></span></div></div></li>');return b.on("mouseenter",function(){b.all(".operate").show()}).on("mouseleave",function(){b.all(".operate").hide()}),b.all(".del-pic").on("click",function(){var a=this;Wanke.T.confirmDelete(function(){$(a).parent().parent().parent().remove(),_class.tool.realign($("#J_UploaderQueue"),"ani"),0==$("#J_UploaderQueue").children().length&&uploadRest()},"\u786e\u5b9a\u8981\u5220\u9664\u8fd9\u5f20\u56fe\u5417\uff1f")}),b}},this.image.event=function(){$.plugin("Dmimi.uploader",{input:$(".btn-uploader").get(),btn:$(".btn-confirm").get(),select:function(b){b=b[0];for(var c=0;c<b.length;c++){var d=document.createElement("img");d.file=b[c],d.t=+new Date;var e=new FileReader;e.onload=function(a){return function(b){$("#J_UploaderQueue").all("img[loadid="+a.t+"]").attr("src",b.target.result)}}(d),e.readAsDataURL(b[c]),$("#J_UploaderQueue").append(a.image.view.preview(d.t))}$.plugin("Dmimi.realign",{ele:$("#J_UploaderQueue")}),a.event.drag()}}),a.$image.all(".close").on("click",function(){a.$image.remove(),a.$overlay.remove()}),a.event.drag=function(){$("#J_UploaderQueue").all(".queue-file").drag(function(b){this.x=b.clientX-parseInt($(this).css("left")),this.y=b.clientY-parseInt($(this).css("top")),$(this).css({opacity:1,zIndex:89}),a.event.dragDown=!0,$("#J_UploaderQueue").all(".queue-space").on("mouseenter",function(){a.event.dragDown&&($(this).css({opacity:1}).animate({width:parseInt($(this).attr("space"))-6},100),a.event.space=$(this))}).on("mouseleave",function(){$(this).css({opacity:0}),a.event.space=null})},function(a){var b=a.clientX-this.x,c=a.clientY-this.y;$(this).css({left:b,top:c})},function(){a.event.space?(a.event.space.before($(this)),$(this).animate({width:100,height:100}),$.plugin("Dmimi.realign",{ele:$("#J_UploaderQueue"),ani:!0}),a.event.space=null):$(this).animate({left:$(this).attr("dleft"),top:$(this).attr("dtop"),width:100,height:100}),$(this).css({opacity:1,zIndex:88}),a.event.dragDown=!1})}},this.image.init()},WKeditor.prototype.font=function(a){var b=this;this.font.init=function(){b.font.reset(),b.font.view(),b.font.event()},this.font.tpl={font:{hugeFont:{text:"\u8d85\u5927\u5b57\u4f53",size:"6",command:"setFontSize"},largeFont:{text:"\u5927\u5b57\u4f53",size:"4",command:"setFontSize"},normalFont:{text:"\u6b63\u5e38\u5b57\u4f53",size:"2",command:"setFontSize"},strongFont:{text:"\u6587\u5b57\u52a0\u7c97",command:"setFontBold"},listText:{text:"\u5217\u8868",command:"insertUnorderedList"},italicText:{text:"\u659c\u4f53",command:"setContentItalic"}},wrap:"<div class='WKeditor_font_plate'></div>",btn:"<div class='box'>{{#each data}}<button command='{{command}}' {{#if size}} size='{{size}}' {{/if}}  class='{{name}} command' title='{{text}}'></button>{{/each}}</div>",arrow:"<div class='arrow'></div>"},this.font.view=function(){b.$font=$(b.font.tpl.wrap),arr=[],temp="";for(var c=0,d=a.length;d>c;c++)arr[c]={name:a[c],command:b.font.tpl.font[a[c]].command,size:b.font.tpl.font[a[c]].size,text:b.font.tpl.font[a[c]].text};temp=new XTemplate(b.font.tpl.btn).render({data:arr}),b.$font.append(temp),b.$font.append(b.font.tpl.arrow),b.$font.width(32*b.$font.all("button").length),b.ele.append(b.$font)},this.font.event=function(){b.$font.all("button").on("click",function(){var a=$(this).attr("command");return"setFontSize"==a?b.command[a]($(this).attr("size")):b.command[a](),!1})},this.font.reset=function(){b.ele.all(".WKeditor_font_plate").remove()},this.font.init()},WKeditor.prototype.tool={browser:function(){var a=window.navigator.userAgent.toLowerCase(),b={version:(a.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],safari:/webkit/.test(a)&&!(/chrome/i.test(a)&&/webkit/i.test(a)&&/mozilla/i.test(a)),opera:/opera/.test(a),msie:/msie/.test(a)&&!/opera/.test(a),mozilla:/mozilla/.test(a)&&!/(compatible|webkit)/.test(a)&&!(/chrome/i.test(a)&&/webkit/i.test(a)&&/mozilla/i.test(a)),chrome:/chrome/i.test(a)&&/webkit/i.test(a)&&/mozilla/i.test(a)};return b},formatBlock:function(){document.execCommand("FormatBlock",!1,"p"),document.execCommand("RemoveFormat")},template:function(obj,json){function fun(str){for(var name in json)if("object"==typeof json[name]){for(var getStr=str.substring(str.indexOf("["+name+"]")+2+name.length,str.lastIndexOf("[/"+name+"]")),newStr="",i=0;i<json[name].length;i++){var newStrP=getStr;for(var s in json[name][i])void 0==json[name][i][s]&&(json[name][i][s]=""),newStrP=newStrP.replace(eval("/{"+s+"}/ig"),json[name][i][s]);newStr+=newStrP}str=str.replace("["+name+"]"+getStr+"[/"+name+"]",newStr)}else void 0==json[name]&&(json[name]=""),str=str.replace(eval("/{"+name+"}/ig"),json[name]);return str}var str;return"object"==typeof obj?(str=String(obj.html()),obj.html(fun(str))):(str=obj,str=fun(str))},removeHTML:function(a){return a=a.toLowerCase(),a=a.replace(/<\/?[^>]*>/g,""),a=a.replace(/[ | ]*\n/g,"\n"),a=a.replace(/[\r\n\s"]/gi,"")},getSelection:function(){return window.getSelection?window.getSelection():document.selection},getRange:function(){try{var a=this.getSelection().createRange?this.getSelection().createRange():this.getSelection().getRangeAt(0);return a.selectText=a.text?a.text:a.toString(),a}catch(b){}},setCart:function(a,b){document.selection&&parseInt(this.browser().version)<9?(b.collapse(!1),b.select()):(b.setStartAfter(a),b.collapse(!0),this.getSelection().removeAllRanges(),this.getSelection().addRange(b))},insert:function(a,b){var c=(this.getSelection(),this.browser());if(!window.getSelection||c.msie&&parseInt(c.version)<10)b.pasteHTML(a);else{for(var d=a,e=d.lastChild;e&&"br"==e.nodeName.toLowerCase()&&e.previousSibling&&"br"==e.previousSibling.nodeName.toLowerCase();){var f=e;e=e.previousSibling,d.removeChild(f)}b.insertNode(d),e&&(b.setEndAfter(e),b.setStartAfter(e))}this.setCart(a,b)}},S.extend(WKeditor,Base,{},{ATTRS:{}}),WKeditor},{requires:["node","base","xtemplate"]});